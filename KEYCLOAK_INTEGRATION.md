# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Keycloak - –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

1. **–î–æ–±–∞–≤–ª–µ–Ω Keycloak –≤ Docker Compose** - —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080
2. **–°–æ–∑–¥–∞–Ω Keycloak –º–æ–¥—É–ª—å** - `apps/server/src/keycloak/`
3. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å AuthService** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Keycloak
4. **–û–±–Ω–æ–≤–ª–µ–Ω JwtAuthGuard** - –≤–∞–ª–∏–¥–∞—Ü–∏—è Keycloak —Ç–æ–∫–µ–Ω–æ–≤
5. **–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã** - keycloak-connect, jsonwebtoken, jwks-rsa, axios

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd apps/server
npm install
```

### 2. –ó–∞–ø—É—Å–∫ Keycloak

```bash
docker-compose -f docker-compose.dev.yml up -d keycloak
```

–ü–æ–¥–æ–∂–¥–∏—Ç–µ ~60 —Å–µ–∫—É–Ω–¥ –ø–æ–∫–∞ Keycloak –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è.

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keycloak

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080
2. –í–æ–π–¥–∏—Ç–µ: `admin` / `admin`
3. –°–æ–∑–¥–∞–π—Ç–µ realm: `memento-mori`
4. –°–æ–∑–¥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞: `memento-mori-backend` (—Å Client authentication = On)
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Client Secret –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: —Å–º. `KEYCLOAK_SETUP.md`

## üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `docker-compose.dev.yml` –∏–ª–∏ `.env`:

```env
KEYCLOAK_URL=http://keycloak:8080
KEYCLOAK_REALM=memento-mori
KEYCLOAK_CLIENT_ID=memento-mori-backend
KEYCLOAK_CLIENT_SECRET=your-secret-here
```

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ `/auth/login` —Å email –∏ –ø–∞—Ä–æ–ª–µ–º
2. –°–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Keycloak
3. –ï—Å–ª–∏ Keycloak –¥–æ—Å—Ç—É–ø–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Keycloak —Ç–æ–∫–µ–Ω
4. –ï—Å–ª–∏ Keycloak –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (fallback)

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `/auth/register`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ Keycloak –∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
3. –†–æ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤

1. JwtAuthGuard –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω
2. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç Keycloak - –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ JWKS
3. –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω - –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ

## üìù –†–æ–ª–∏

Keycloak —Ä–æ–ª–∏ –º–∞–ø–ø—è—Ç—Å—è –Ω–∞ —Ä–æ–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- `client` ‚Üí `CLIENT`
- `vendor` ‚Üí `VENDOR`
- `lawyer-notary` ‚Üí `LAWYER_NOTARY`
- `admin` ‚Üí `ADMIN`

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
docker-compose -f docker-compose.dev.yml ps keycloak

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose -f docker-compose.dev.yml logs keycloak

# –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password"}'
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ: `KEYCLOAK_SETUP.md`
- Keycloak –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://www.keycloak.org/documentation

