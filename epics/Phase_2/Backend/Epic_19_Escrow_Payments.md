# Epic 19: Escrow Payments

**Phase:** Phase 2  
**Portal:** Backend  
**Module:** PaymentsModule  
**Epic ID:** E-019

---

## Описание

Реализация Escrow системы для безопасных платежей. Включает удержание средств, освобождение средств и dispute resolution.

---

## Функциональность

- Escrow логика (удержание средств)
- Освобождение средств (автоматическое и ручное)
- Dispute resolution (разрешение споров)
- Статусы Escrow транзакций
- Уведомления о статусах Escrow
- Интеграция со Stripe для Escrow

**Исключено из Phase 2:**
- Автоматическое освобождение по времени
- Сложные dispute workflows

---

## Зависимости

**Предшествующие эпики:**
- ✅ Epic 6: Backend Payments (MVP) (MUST)

**Требует завершения:**
- Epic 6 должен быть завершен (базовые платежи работают)

**Блокирует:**
- Epic 24: Client App - Escrow Payments
- Epic 28: Vendor Portal - Escrow
- Epic 30: Admin Portal - Escrow Management

---

## Приоритет (MoSCoW)

**Must Have** - Критичный для Phase 2

Escrow система - это ключевое конкурентное преимущество платформы.

---

## Story Points

**Оценка:** 21 points

**Обоснование:**
- Escrow логика: 5 points
- Удержание средств: 3 points
- Освобождение средств: 3 points
- Dispute resolution: 5 points
- Интеграция со Stripe: 3 points
- Уведомления: 2 points

---

## Последовательность разработки

**Порядок:** 19 (первый в Phase 2, после Epic 6)

**Последовательность:**
1. Escrow логика и модель данных
2. Удержание средств
3. Освобождение средств (автоматическое)
4. Освобождение средств (ручное)
5. Dispute resolution
6. Интеграция со Stripe
7. Уведомления

---

## Параллельная разработка

**Возможна параллельная работа:**
- ✅ Frontend команда может начать работу над UI после определения API контракта
- ✅ Dispute resolution может разрабатываться параллельно с освобождением средств

**Не может быть параллельной:**
- ❌ Нужна интеграция с Epic 6 (Payments)
- ❌ Frontend не может интегрироваться без готового API

---

## Критерии готовности (Definition of Done)

- [ ] Escrow логика работает
- [ ] Удержание средств работает
- [ ] Освобождение средств работает (автоматическое и ручное)
- [ ] Dispute resolution работает
- [ ] Интеграция со Stripe работает
- [ ] Уведомления отправляются
- [ ] Безопасность обеспечена
- [ ] Unit тесты написаны (покрытие > 80%)
- [ ] API документация обновлена
- [ ] Code review пройден

---

## User Stories (примеры)

1. **Как Client**, я хочу, чтобы средства удерживались до выполнения услуги
2. **Как Vendor**, я хочу получить средства после выполнения услуги
3. **Как Admin**, я хочу разрешать споры, чтобы защитить обе стороны
4. **Как система**, я должна автоматически освобождать средства при подтверждении выполнения

---

## Технические детали

**Технологии:**
- NestJS
- Stripe (Payment Intents с capture_method)
- Prisma ORM

**API Endpoints:**
- `POST /payments/escrow/hold` - Удержание средств
- `POST /payments/escrow/release` - Освобождение средств
- `POST /payments/escrow/dispute` - Создание спора
- `GET /payments/escrow/:id` - Статус Escrow транзакции

**Database:**
- EscrowTransaction model (Prisma)
- EscrowStatus enum (HELD, RELEASED, DISPUTED, REFUNDED)

---

## Риски и митигация

**Риски:**
- Сложность Escrow логики
- Безопасность транзакций
- Dispute resolution процесс

**Митигация:**
- Тщательное проектирование
- Security review
- Четкие правила dispute resolution

---

## Примечания

Критичный эпик для Phase 2. Это ключевое конкурентное преимущество платформы.

