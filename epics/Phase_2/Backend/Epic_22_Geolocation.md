# Epic 22: Geolocation (PostGIS)

**Phase:** Phase 2  
**Portal:** Backend  
**Module:** LocationsModule  
**Epic ID:** E-022

---

## Описание

Геопоиск услуг и адвокатов с использованием PostGIS. Включает поиск по координатам, почтовым индексам и расстоянию.

---

## Функциональность

- Геопоиск услуг (PostGIS)
- Геопоиск адвокатов (PostGIS)
- Поиск по координатам
- Поиск по почтовому индексу
- Фильтрация по расстоянию
- Расчет расстояний

**Исключено из Phase 2:**
- Отображение на карте (это frontend)
- Маршруты и навигация

---

## Зависимости

**Предшествующие эпики:**
- ✅ Epic 3: Backend Services Catalog (MUST)
- ✅ Epic 21: Lawyer/Notary Management (MUST)

**Требует завершения:**
- Epic 3 должен быть завершен (Services для геопоиска)
- Epic 21 должен быть завершен (Lawyers для геопоиска)

**Блокирует:**
- Epic 26: Client App - Geolocation

---

## Приоритет (MoSCoW)

**Should Have** - Важный для Phase 2

Геопоиск улучшает UX, но не критичен для базовой работы.

---

## Story Points

**Оценка:** 13 points

**Обоснование:**
- Настройка PostGIS: 3 points
- Геопоиск услуг: 3 points
- Геопоиск адвокатов: 3 points
- Поиск по почтовому индексу: 2 points
- Фильтрация по расстоянию: 2 points

---

## Последовательность разработки

**Порядок:** 22 (после Epic 3, 21)

**Последовательность:**
1. Настройка PostGIS в PostgreSQL
2. Добавление геолокации в модели
3. Геопоиск услуг
4. Геопоиск адвокатов
5. Поиск по почтовому индексу
6. Фильтрация по расстоянию

---

## Параллельная разработка

**Возможна параллельная работа:**
- ✅ Может разрабатываться параллельно с Epic 20 (Wills)
- ✅ Frontend может работать над UI параллельно

**Не может быть параллельной:**
- ❌ Нужна интеграция с Epic 3, 21

---

## Критерии готовности (Definition of Done)

- [ ] PostGIS настроен
- [ ] Геопоиск услуг работает
- [ ] Геопоиск адвокатов работает
- [ ] Поиск по почтовому индексу работает
- [ ] Фильтрация по расстоянию работает
- [ ] Unit тесты написаны (покрытие > 80%)
- [ ] API документация обновлена
- [ ] Code review пройден

---

## User Stories (примеры)

1. **Как Client**, я хочу найти услуги рядом со мной, чтобы быстро получить услугу
2. **Как Client**, я хочу найти адвоката по почтовому индексу, чтобы оформить завещание
3. **Как система**, я должна показывать услуги в радиусе X км от клиента

---

## Технические детали

**Технологии:**
- NestJS
- PostGIS (PostgreSQL extension)
- Prisma ORM (с PostGIS поддержкой)

**API Endpoints:**
- `GET /services/search/location` - Геопоиск услуг
- `GET /lawyer-notary/search/location` - Геопоиск адвокатов
- Параметры: lat, lng, radius, postalCode

**Database:**
- PostGIS extension
- Геолокация в Service и LawyerNotaryProfile моделях

---

## Риски и митигация

**Риски:**
- Сложность настройки PostGIS
- Производительность геопоиска

**Митигация:**
- Использование индексов PostGIS
- Оптимизация запросов
- Кэширование результатов

---

## Примечания

Важный эпик для Phase 2. Улучшает UX и является конкурентным преимуществом.

