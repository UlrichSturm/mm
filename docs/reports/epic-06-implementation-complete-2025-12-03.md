# Epic 6: Payments - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

**–î–∞—Ç–∞:** 2025-12-03
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **100% –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –î–æ–±–∞–≤–ª–µ–Ω endpoint POST /api/payments/confirm (US-030)

**–§–∞–π–ª:** `apps/server/src/payments/payments.controller.ts`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è Payment Intent —á–µ—Ä–µ–∑ Stripe
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `succeeded`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∑–∞–∫–∞–∑–∞)
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ Payment –∏ Order
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏

**–ö–æ–¥:**
```typescript
@Post('confirm')
@Roles({ roles: ['client'] })
async confirmPayment(@Request() req: any, @Body() dto: ConfirmPaymentDto) {
  // Verify with Stripe
  const paymentIntent = await this.stripeService.getPaymentIntent(dto.paymentIntentId);
  if (paymentIntent.status !== 'succeeded') {
    throw new BadRequestException('Payment not successful');
  }

  // Verify ownership and confirm
  return this.paymentsService.confirmPayment(dto.paymentIntentId);
}
```

---

### 2. –£–ª—É—á—à–µ–Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ `confirmPayment()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ COMPLETED –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ `handlePaymentFailed()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ FAILED
- ‚úÖ `handleRefund()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ REFUNDED
- ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤

---

### 3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ `payment_intent.canceled` —Å–æ–±—ã—Ç–∏—è
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ event.id –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ Try-catch –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π

**–ö–æ–¥:**
```typescript
async handleWebhook(event: Stripe.Event) {
  this.logger.log(`Processing webhook event: ${event.type} (id: ${event.id})`);

  try {
    switch (event.type) {
      case 'payment_intent.succeeded': // ...
      case 'payment_intent.payment_failed': // ...
      case 'payment_intent.canceled': // ... –ù–û–í–û–ï
      case 'charge.refunded': // ...
    }
  } catch (error) {
    // Graceful error handling
  }
}
```

---

### 4. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ Try-catch –≤ `createPaymentIntent()` –¥–ª—è Stripe API
- ‚úÖ –û—Ç–º–µ–Ω–∞ Payment Intent –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

### 5. –î–æ–±–∞–≤–ª–µ–Ω –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

**–ú–µ—Ç–æ–¥:** `findPaymentByIntentId()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ Stripe Payment Intent ID –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ.

---

## üìã –í—Å–µ endpoints Epic 6

| Endpoint | Method | –†–æ–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----------|--------|------|----------|--------|
| `/api/payments/intent` | POST | client | –°–æ–∑–¥–∞–Ω–∏–µ Payment Intent | ‚úÖ |
| `/api/payments/confirm` | POST | client | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ | ‚úÖ **–ù–û–í–´–ô** |
| `/api/payments/my` | GET | client | –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π | ‚úÖ |
| `/api/payments/:id` | GET | all | –î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞ | ‚úÖ |
| `/api/payments/webhook` | POST | public | Webhook –æ—Ç Stripe | ‚úÖ |
| `/api/payments` | GET | admin | –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ | ‚úÖ |
| `/api/payments/:id/refund` | POST | admin | –í–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞ | ‚úÖ |

---

## ‚úÖ User Stories

| US | –ù–∞–∑–≤–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----|----------|--------|
| US-029 | –°–æ–∑–¥–∞–Ω–∏–µ Payment Intent | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| US-030 | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ | ‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û** |
| US-031 | –û–±—Ä–∞–±–æ—Ç–∫–∞ Stripe Webhook | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| US-032 | –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–í—Å–µ –º–µ—Ç–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã:
- ‚úÖ `confirmPayment()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ `handlePaymentFailed()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ `handleRefund()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- ‚úÖ –í—Å–µ Stripe API –≤—ã–∑–æ–≤—ã –æ–±–µ—Ä–Ω—É—Ç—ã –≤ try-catch
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
- ‚úÖ Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö webhook

### Webhook —Å–æ–±—ã—Ç–∏—è

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è:
- ‚úÖ `payment_intent.succeeded`
- ‚úÖ `payment_intent.payment_failed`
- ‚úÖ `payment_intent.canceled` (–Ω–æ–≤–æ–µ)
- ‚úÖ `charge.refunded`

---

## üìä –°—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: **100%**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å |
|-----------|--------|------------|
| PaymentsService | ‚úÖ | 100% |
| PaymentsController | ‚úÖ | 100% |
| StripeService | ‚úÖ | 100% |
| DTOs | ‚úÖ | 100% |
| Prisma Schema | ‚úÖ | 100% |
| Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ | ‚úÖ | 100% |
| –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å | ‚úÖ | 100% |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | ‚úÖ | 100% |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:

1. ‚úÖ –í—Å–µ endpoints –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Swagger UI
2. ‚úÖ Keycloak –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
3. ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Stripe test mode
4. ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

- ‚è≥ `STRIPE_SECRET_KEY` (test key)
- ‚è≥ `STRIPE_WEBHOOK_SECRET` (–¥–ª—è webhook)
- ‚è≥ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ (PENDING —Å—Ç–∞—Ç—É—Å)

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ endpoints —á–µ—Ä–µ–∑ Swagger UI
2. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Stripe test mode
3. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook –æ–±—Ä–∞–±–æ—Ç–∫—É
4. ‚è≥ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (Epic 8)

---

## ‚úÖ Definition of Done

- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Stripe —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Payment Intents —Å–æ–∑–¥–∞—é—Ç—Å—è
- ‚úÖ –ü–ª–∞—Ç–µ–∂–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- ‚úÖ Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π –æ–±–µ—Å–ø–µ—á–µ–Ω–∞
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —É–ª—É—á—à–µ–Ω–∞
- ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Stripe test mode (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
- ‚è≥ Unit —Ç–µ—Å—Ç—ã (TODO)
- ‚úÖ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (Swagger)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-12-03

