# –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Keycloak

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ Keycloak –¥–æ–±–∞–≤–ª–µ–Ω –≤ `docker-compose.dev.yml`
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö `keycloak` —Å–æ–∑–¥–∞–Ω–∞ –≤ PostgreSQL
- ‚úÖ Keycloak –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8080
- ‚úÖ Health checks –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

### 2. Backend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω `KeycloakService` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Keycloak API
- ‚úÖ –°–æ–∑–¥–∞–Ω `KeycloakModule` –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ `AppModule`
- ‚úÖ `AuthService` –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å Keycloak:
  - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Keycloak (—Å fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é)
  - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Keycloak
  - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ JWKS
- ‚úÖ `JwtAuthGuard` –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Keycloak —Ç–æ–∫–µ–Ω–∞–º–∏
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ npm –ø–∞–∫–µ—Ç—ã:
  - `jsonwebtoken`
  - `jwks-rsa`
  - `axios`

### 3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–ª–µ `password` –≤ —Å—Ö–µ–º–µ Prisma —Å–¥–µ–ª–∞–Ω–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

## ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ö–†–ò–¢–ò–ß–ù–û)

–í `docker-compose.dev.yml` –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ `server` –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å:
```yaml
environment:
  - KEYCLOAK_URL=http://keycloak:8080
  - KEYCLOAK_REALM=memento-mori
  - KEYCLOAK_CLIENT_ID=memento-mori-backend
  - KEYCLOAK_CLIENT_SECRET=your-client-secret-here  # ‚ö†Ô∏è –ù–£–ñ–ù–û –ó–ê–ú–ï–ù–ò–¢–¨
```

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, –Ω–æ `KEYCLOAK_CLIENT_SECRET` —Å–æ–¥–µ—Ä–∂–∏—Ç placeholder.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keycloak (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

#### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ Realm
1. –í–æ–π—Ç–∏ –≤ http://localhost:8080 (admin/admin)
2. –°–æ–∑–¥–∞—Ç—å realm `memento-mori`

#### 2.2. –°–æ–∑–¥–∞–Ω–∏–µ Client –¥–ª—è Backend
1. Client ID: `memento-mori-backend`
2. Client authentication: **On** (–≤–∫–ª—é—á–∏—Ç—å)
3. Valid redirect URIs: `http://localhost:3001/*`
4. Web origins: `http://localhost:3000`, `http://localhost:3002`, `http://localhost:3003`
5. **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Client Secret** –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ `docker-compose.dev.yml`

#### 2.3. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–µ–π
–°–æ–∑–¥–∞—Ç—å realm roles:
- `client`
- `vendor`
- `lawyer-notary`
- `admin`

#### 2.4. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ù–∞–∑–Ω–∞—á–∏—Ç—å –∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–æ–ª–∏

### 3. Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- Client (apps/client)
- Admin Portal (apps/admin-portal)
- Vendor Portal (apps/vendor-portal)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** Frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Keycloak.

## üîÑ –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ **–≥–∏–±—Ä–∏–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ**:
1. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞ —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Keycloak
2. –ï—Å–ª–∏ Keycloak –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
3. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

## üìã –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

- [ ] –û–±–Ω–æ–≤–∏—Ç—å `KEYCLOAK_CLIENT_SECRET` –≤ `docker-compose.dev.yml`
- [ ] –°–æ–∑–¥–∞—Ç—å realm `memento-mori` –≤ Keycloak
- [ ] –°–æ–∑–¥–∞—Ç—å client `memento-mori-backend` –≤ Keycloak
- [ ] –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å Client Secret –∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å —Ä–æ–ª–∏ –≤ Keycloak (client, vendor, lawyer-notary, admin)
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ Keycloak
- [ ] (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û–±–Ω–æ–≤–∏—Ç—å frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Keycloak

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Keycloak
curl http://localhost:8080/health/ready

# 2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Keycloak)
curl -X POST http://localhost:3001/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–∞
curl http://localhost:3001/auth/profile \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: `KEYCLOAK_SETUP.md`
- –ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: `KEYCLOAK_INTEGRATION.md`

