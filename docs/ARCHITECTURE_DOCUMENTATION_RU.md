# Документация архитектуры - Memento Mori

**Дата:** 2025-12-07
**Версия:** 1.0
**Статус:** Технический справочный документ

---

## 📋 Содержание

1. [Обзор архитектуры](#обзор-архитектуры)
2. [Системная архитектура](#системная-архитектура)
3. [Архитектура приложений](#архитектура-приложений)
4. [Архитектура данных](#архитектура-данных)
5. [Архитектура безопасности](#архитектура-безопасности)
6. [Архитектура интеграций](#архитектура-интеграций)
7. [Архитектура развертывания](#архитектура-развертывания)
8. [Масштабируемость и производительность](#масштабируемость-и-производительность)
9. [Технологический стек](#технологический-стек)

---

## Обзор архитектуры

### Архитектура высокого уровня

Memento Mori построен как **monorepo** с **архитектурой, готовой к микросервисам**, в настоящее время реализован как модульный монолит, который может быть разделен на микросервисы по мере необходимости.

### Принципы архитектуры

1. **Разделение ответственности:** Четкие границы между frontend, backend и инфраструктурой
2. **Модульность:** Независимые модули, которые могут разрабатываться и развертываться отдельно
3. **Масштабируемость:** Разработано для горизонтального масштабирования
4. **Безопасность прежде всего:** Встроенная аутентификация, авторизация и защита данных
5. **API-First:** RESTful API с четкими контрактами
6. **Cloud-Native:** Разработано для облачного развертывания (AWS/GCP)

### Компоненты системы

```
┌─────────────────────────────────────────────────────────┐
│              Клиентские приложения                        │
├──────────────┬──────────────┬──────────────┬──────────┤
│  Client App  │ Vendor Portal│ Admin Portal │  Mobile  │
│  (Next.js)   │  (Next.js)   │  (Next.js)   │  (Future)│
└──────┬───────┴──────┬───────┴──────┬───────┴──────┬───┘
       │              │              │              │
       └──────────────┴──────────────┴──────────────┘
                      │
       ┌──────────────▼──────────────┐
       │      API Gateway / Load      │
       │         Balancer             │
       └──────────────┬──────────────┘
                      │
       ┌──────────────▼──────────────┐
       │      Backend API (NestJS)    │
       │  ┌────────────────────────┐  │
       │  │  Business Logic Layer  │  │
       │  └────────────────────────┘  │
       └──────────────┬──────────────┘
                      │
    ┌─────────────────┼─────────────────┐
    │                 │                 │
┌───▼───┐      ┌──────▼──────┐    ┌────▼────┐
│PostgreSQL│    │   Redis     │    │ Keycloak│
│ Database │    │   Cache     │    │   Auth  │
└─────────┘    └─────────────┘    └─────────┘
```

---

## Системная архитектура

### Структура Monorepo

```
MM/
├── apps/
│   ├── server/          # NestJS Backend API (Порт 3001)
│   ├── client/          # Next.js Client App (Порт 3000)
│   ├── vendor-portal/   # Next.js Vendor Portal (Порт 3002)
│   └── admin-portal/    # Next.js Admin Portal (Порт 3003)
├── packages/
│   └── shared/          # Общие типы, утилиты, компоненты
├── docs/                # Документация
├── scripts/             # Утилитарные скрипты
└── docker/              # Docker конфигурации
```

### Коммуникация сервисов

**Текущая (Монолит):**
- Все сервисы в одном NestJS приложении
- Внутренняя коммуникация модулей через dependency injection
- Общая база данных

**Будущая (Микросервисы):**
- API Gateway для маршрутизации
- Коммуникация между сервисами через REST/gRPC
- Событийно-ориентированная архитектура для асинхронных операций
- Специфичные для сервисов базы данных (при необходимости)

---

## Архитектура приложений

### Backend архитектура (NestJS)

#### Структура модулей

```
AppModule (Root)
├── DatabaseModule (Prisma Client)
├── LoggerModule (Логирование и отслеживание ошибок)
├── AuthModule (Аутентификация и авторизация)
│   ├── Интеграция Keycloak
│   ├── JWT Strategy
│   ├── JwtAuthGuard
│   └── RolesGuard
├── VendorsModule (Управление поставщиками)
├── LawyerNotaryModule (Управление адвокатами/нотариусами)
├── CategoriesModule (Иерархия категорий)
├── ServicesModule (Управление услугами)
├── OrdersModule (Обработка заказов)
├── PaymentsModule (Обработка платежей)
├── ReviewsModule (Система отзывов)
├── WillsModule (Управление завещаниями)
├── MemorialsModule (Мемориальные страницы)
├── LocationsModule (Геолокационные сервисы)
├── UsersModule (Управление пользователями)
├── AdminModule (Административные операции)
└── EmailModule (Email уведомления)
```

#### Архитектура слоев

```
Слой контроллеров (REST эндпоинты)
    ↓
Слой сервисов (Бизнес-логика)
    ↓
Слой репозиториев (Доступ к данным - Prisma)
    ↓
Слой базы данных (PostgreSQL)
```

### Frontend архитектура (Next.js)

#### Структура приложений

**Client App:**
```
app/
├── (auth)/          # Маршруты аутентификации
├── (catalog)/       # Каталог услуг
├── (orders)/        # Управление заказами
├── (payments)/      # Обработка платежей
├── (wills)/         # Услуга завещаний
└── layout.tsx       # Корневой layout
```

**Vendor Portal:**
```
app/
├── (auth)/          # Аутентификация
├── (dashboard)/     # Панель управления
├── (services)/      # Управление услугами
├── (orders)/        # Управление заказами
├── (appointments)/  # Планирование встреч
└── layout.tsx
```

**Admin Portal:**
```
app/
├── (auth)/          # Аутентификация
├── (dashboard)/     # Админ панель
├── (vendors)/       # Модерация поставщиков
├── (services)/      # Модерация услуг
├── (users)/         # Управление пользователями
└── layout.tsx
```

---

## Архитектура данных

### Схема базы данных

**Основная база данных:** PostgreSQL 15

#### Основные модели

1. **User** - Учетные записи пользователей и аутентификация
2. **VendorProfile** - Бизнес-информация поставщиков
3. **LawyerNotary** - Профили адвокатов/нотариусов
4. **Service** - Каталог услуг/товаров
5. **Category** - Категории услуг
6. **Order** - Заказы клиентов
7. **Payment** - Транзакции платежей
8. **Review** - Отзывы на услуги
9. **Will** - Документы завещаний
10. **Memorial** - Мемориальные страницы

### Стратегия кэширования

**Слой кэширования:** Redis

- **Хранение сессий:** Сессии пользователей
- **Кэширование ответов API:** Часто запрашиваемые данные
- **Ограничение скорости:** Ограничение запросов
- **Функции реального времени:** Pub/Sub для уведомлений

---

## Архитектура безопасности

### Аутентификация и авторизация

**Провайдер идентичности:** Keycloak

- **Single Sign-On (SSO):** Централизованная аутентификация
- **Multi-Factor Authentication (MFA):** Опциональная 2FA
- **Социальный вход:** OAuth2 провайдеры
- **Управление токенами:** JWT access & refresh токены

### Модель авторизации

**Ролевой контроль доступа (RBAC):**

- **CLIENT:** Конечные пользователи, могут размещать заказы
- **VENDOR:** Поставщики услуг, управляют услугами/заказами
- **LAWYER_NOTARY:** Юридические специалисты, обрабатывают завещания
- **ADMIN:** Администраторы платформы, полный доступ

### Уровни безопасности

1. **Сетевой уровень:**
   - Шифрование HTTPS/TLS
   - Правила файрвола
   - Защита от DDoS

2. **Уровень приложения:**
   - Валидация входных данных
   - Защита от SQL инъекций (Prisma)
   - Защита от XSS
   - CSRF токены

3. **Уровень данных:**
   - Шифрованные соединения с базой данных
   - Шифрование чувствительных данных в покое
   - Защита PII (соответствие GDPR)

4. **Безопасность платежей:**
   - Соответствие PCI DSS (через Stripe)
   - Система Escrow для защиты средств
   - Безопасная обработка платежей

### Соответствие требованиям

- **GDPR:** Защита данных и конфиденциальность
- **PCI DSS:** Стандарты индустрии платежных карт
- **SOC 2:** Безопасность и доступность (будущее)

---

## Архитектура интеграций

### Внешние сервисы

#### Обработка платежей

**Интеграция Stripe:**
- Payment Intents API
- Обработчики webhooks
- Система Escrow
- Обработка возвратов

#### Email сервис

**Mailgun/SendGrid:**
- Транзакционные emails
- Уведомительные emails
- Система шаблонов (Handlebars)

#### Хранилище

**S3/MinIO:**
- Загрузка файлов
- Хранение документов
- Хостинг изображений
- Интеграция CDN

#### Аутентификация

**Keycloak:**
- Управление пользователями
- Потоки аутентификации
- Выдача токенов
- Управление ролями

---

## Архитектура развертывания

### Среда разработки

**Docker Compose:**
- Контейнер PostgreSQL
- Контейнер Redis
- Контейнер Keycloak
- Контейнер MailHog (тестирование email)
- Все контейнеры приложений

### Production среда

**Облачная платформа:** AWS/GCP

**Архитектура:**
```
Интернет
    ↓
Облачный балансировщик нагрузки
    ↓
Серверы приложений (ECS/Kubernetes)
    ├── Backend API (NestJS)
    ├── Client App (Next.js)
    ├── Vendor Portal (Next.js)
    └── Admin Portal (Next.js)
    ↓
Управляемые сервисы
    ├── RDS PostgreSQL
    ├── ElastiCache Redis
    ├── S3/Cloud Storage
    └── Keycloak (Управляемый или Self-hosted)
```

### CI/CD пайплайн

**GitHub Actions:**
1. Push кода запускает пайплайн
2. Запуск тестов (unit, integration)
3. Сборка Docker образов
4. Push в реестр контейнеров
5. Развертывание в staging/production
6. Запуск smoke тестов
7. Мониторинг развертывания

---

## Масштабируемость и производительность

### Горизонтальное масштабирование

- **Бесстатусные приложения:** Все приложения бесстатусны, могут масштабироваться горизонтально
- **Балансировка нагрузки:** Распределение трафика между экземплярами
- **Масштабирование базы данных:** Реплики чтения для операций с интенсивным чтением
- **Кэширование:** Redis для часто запрашиваемых данных

### Оптимизация производительности

1. **База данных:**
   - Индексы на часто запрашиваемых полях
   - Оптимизация запросов
   - Пул соединений
   - Реплики чтения

2. **Приложение:**
   - Разделение кода (Next.js)
   - Ленивая загрузка
   - Кэширование ответов API
   - CDN для статических ресурсов

3. **Frontend:**
   - Server-side rendering (SSR)
   - Static site generation (SSG)
   - Оптимизация изображений
   - Минификация кода

### Мониторинг и наблюдаемость

- **Мониторинг приложений:** Sentry, Datadog
- **Логирование:** Централизованное логирование (ELK stack)
- **Метрики:** Prometheus, Grafana
- **APM:** Мониторинг производительности приложений
- **Мониторинг времени работы:** Проверки здоровья, алерты

---

## Технологический стек

### Backend

| Технология | Версия | Назначение |
|------------|--------|------------|
| **Node.js** | 20+ | Среда выполнения |
| **NestJS** | 10 | Фреймворк |
| **TypeScript** | 5 | Язык |
| **Prisma** | 6 | ORM |
| **PostgreSQL** | 15 | База данных |
| **Redis** | 7 | Кэш и сессии |
| **Keycloak** | 24 | Аутентификация |
| **Stripe** | Latest | Платежи |

### Frontend

| Технология | Версия | Назначение |
|------------|--------|------------|
| **Next.js** | 14 | Фреймворк |
| **React** | 18 | UI библиотека |
| **TypeScript** | 5 | Язык |
| **Tailwind CSS** | 3.4 | Стилизация |
| **React Query** | 5 | Получение данных |
| **Zod** | 3 | Валидация |

### Инфраструктура

| Технология | Назначение |
|------------|------------|
| **Docker** | Контейнеризация |
| **Docker Compose** | Локальная разработка |
| **GitHub Actions** | CI/CD |
| **AWS/GCP** | Облачный хостинг |
| **Terraform** | Infrastructure as Code (будущее) |

---

## Приложение

### Связанные документы

- [Системная архитектура](docs/SYSTEM_ARCHITECTURE.md)
- [Схема базы данных](docs/DATABASE_SCHEMA.md)
- [Справочник API](docs/API_REFERENCE.md)
- [Руководство по разработке](docs/DEVELOPMENT.md)

---

**Последнее обновление:** 7 декабря 2025
**Поддерживается:** Техлидом

