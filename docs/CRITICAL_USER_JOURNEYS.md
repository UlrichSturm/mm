# Critical User Journeys - Memento Mori Platform

**Дата создания:** 4 декабря 2025
**Версия:** 1.0

---

## Обзор

Документ описывает критические пути пользователей (Critical User Journeys) для каждой роли в системе Memento Mori. Критический путь - это последовательность действий, которую пользователь должен выполнить для достижения основной цели своей роли.

---

## Роли в системе

1. **CLIENT** - Клиент, заказывающий услуги
2. **VENDOR** - Вендор, предоставляющий услуги
3. **ADMIN** - Администратор, управляющий платформой

---

## 1. CLIENT - Критический путь клиента

### 1.1 Регистрация и первый вход

**Шаги:**

1. Переход на главную страницу платформы
2. Нажатие "Регистрация" / "Sign Up"
3. Заполнение формы регистрации:
   - Email
   - Пароль (минимум 8 символов)
   - Имя (firstName)
   - Фамилия (lastName, опционально)
   - Телефон (опционально)
4. Подтверждение email (если требуется)
5. Автоматический вход после регистрации
6. **Email:** Получение welcome email с приветствием

**API Endpoints:**

- `POST /api/v1/auth/register`
- `POST /api/v1/auth/login` (автоматически после регистрации)

**Ожидаемый результат:**

- Пользователь зарегистрирован в Keycloak
- Профиль создан в базе данных
- Роль CLIENT назначена
- Welcome email отправлен

---

### 1.2 Заполнение профиля

**Шаги:**

1. Переход в "Мой профиль" / "My Profile"
2. Заполнение дополнительной информации:
   - Телефон (если не указан при регистрации)
   - Адрес доставки (опционально)
   - Предпочтения уведомлений
3. Сохранение изменений

**API Endpoints:**

- `GET /api/v1/auth/profile` - получение профиля
- `PATCH /api/v1/auth/profile` - обновление профиля

**Ожидаемый результат:**

- Профиль обновлен
- Данные сохранены в базе

---

### 1.3 Поиск и просмотр услуг

**Шаги:**

1. Переход в каталог услуг / "Services Catalog"
2. Использование фильтров:
   - По категории (похороны, кремация, памятники и т.д.)
   - По цене (мин/макс)
   - По местоположению вендора
   - По рейтингу
3. Поиск по ключевым словам
4. Просмотр детальной информации об услуге:
   - Описание
   - Цена
   - Длительность
   - Информация о вендоре
   - Отзывы (если есть)
   - Фотографии

**API Endpoints:**

- `GET /api/v1/services` - список услуг с фильтрами
- `GET /api/v1/services/:id` - детали услуги
- `GET /api/v1/categories` - список категорий

**Ожидаемый результат:**

- Пользователь находит нужные услуги
- Видит актуальные цены и доступность

---

### 1.4 Добавление услуг в заказ

**Шаги:**

1. Выбор услуги из каталога
2. Нажатие "Добавить в заказ" / "Add to Order"
3. Указание количества (если применимо)
4. Добавление заметок/пожеланий (опционально)
5. Повторение для дополнительных услуг
6. Просмотр корзины заказа:
   - Список выбранных услуг
   - Итоговая стоимость (с учетом НДС 19%)
   - Расчетная дата выполнения

**API Endpoints:**

- `POST /api/v1/orders` - создание заказа
  - Body: `{ items: [{ serviceId, quantity, notes }], notes, scheduledDate }`

**Ожидаемый результат:**

- Заказ создан со статусом PENDING
- Номер заказа сгенерирован (формат: ORD-YYYY-XXXXXX)
- Email уведомление о создании заказа (опционально)

---

### 1.5 Оформление и оплата заказа

**Шаги:**

1. Переход к оформлению заказа
2. Проверка деталей заказа:
   - Список услуг
   - Итоговая стоимость
   - Информация о вендорах
3. Выбор способа оплаты (Stripe)
4. Создание Payment Intent:
   - Ввод данных карты
   - Подтверждение оплаты
5. Ожидание подтверждения оплаты
6. Получение подтверждения

**API Endpoints:**

- `GET /api/v1/orders/:id` - получение деталей заказа
- `POST /api/v1/payments/intent` - создание payment intent
  - Body: `{ orderId }`
- Webhook: `payment_intent.succeeded` - подтверждение оплаты

**Ожидаемый результат:**

- Payment Intent создан
- Оплата подтверждена
- Статус заказа изменен на CONFIRMED
- Email: Order Confirmation отправлен клиенту
- Email: Order Status Update отправлен вендору

---

### 1.6 Отслеживание заказа

**Шаги:**

1. Переход в "Мои заказы" / "My Orders"
2. Просмотр списка заказов:
   - Номер заказа
   - Статус (PENDING, CONFIRMED, IN_PROGRESS, COMPLETED, CANCELLED, REFUNDED)
   - Дата создания
   - Итоговая стоимость
3. Просмотр деталей конкретного заказа
4. Отслеживание изменений статуса

**API Endpoints:**

- `GET /api/v1/orders` - список заказов клиента
- `GET /api/v1/orders/:id` - детали заказа

**Email уведомления:**

- Order Status Update при каждом изменении статуса

**Ожидаемый результат:**

- Клиент видит актуальный статус заказа
- Получает уведомления об изменениях

---

### 1.7 Отмена заказа (если необходимо)

**Шаги:**

1. Переход к заказу со статусом PENDING
2. Нажатие "Отменить заказ" / "Cancel Order"
3. Указание причины отмены (опционально)
4. Подтверждение отмены

**API Endpoints:**

- `PATCH /api/v1/orders/:id/status` - обновление статуса
  - Body: `{ status: CANCELLED, reason?: string }`

**Ожидаемый результат:**

- Статус заказа изменен на CANCELLED
- Email уведомление об отмене отправлено клиенту и вендору
- Возврат средств (если оплата была произведена)

---

### 1.8 Получение услуги и завершение

**Шаги:**

1. Вендор обновляет статус заказа на IN_PROGRESS
2. Выполнение услуги вендором
3. Вендор обновляет статус на COMPLETED
4. Клиент получает уведомление о завершении
5. Возможность оставить отзыв (будущая функция)

**API Endpoints:**

- (Вендор) `PATCH /api/v1/orders/:id/status` - обновление статуса

**Email уведомления:**

- Order Status Update: IN_PROGRESS
- Order Status Update: COMPLETED

**Ожидаемый результат:**

- Услуга выполнена
- Заказ завершен
- Клиент доволен результатом

---

## 2. VENDOR - Критический путь вендора

### 2.1 Регистрация и создание профиля вендора

**Шаги:**

1. Регистрация как обычный пользователь (см. 1.1)
2. Переход в "Стать вендором" / "Become a Vendor"
3. Заполнение формы профиля вендора:
   - Название бизнеса (businessName) \*
   - Email для связи (contactEmail) \*
   - Телефон (contactPhone)
   - Адрес (address)
   - Почтовый индекс (postalCode)
   - Описание бизнеса
   - Документы (лицензии, сертификаты) - будущая функция
4. Отправка заявки на рассмотрение
5. Ожидание одобрения администратором

**API Endpoints:**

- `POST /api/v1/vendors` - создание профиля вендора
  - Body: `{ businessName, email, phone?, address?, postalCode? }`

**Ожидаемый результат:**

- Профиль вендора создан со статусом PENDING
- Роль VENDOR назначена пользователю
- Заявка отправлена на модерацию
- Email уведомление о подаче заявки отправлено вендору

---

### 2.2 Ожидание одобрения

**Шаги:**

1. Проверка статуса заявки в личном кабинете
2. Ожидание решения администратора
3. Получение уведомления о решении

**API Endpoints:**

- `GET /api/v1/vendors/me` - получение своего профиля вендора

**Email уведомления:**

- Vendor Approval Email (при одобрении)
- Vendor Rejection Email (при отклонении)

**Ожидаемый результат:**

- Вендор получает уведомление о решении
- При одобрении: статус изменен на APPROVED
- При отклонении: статус изменен на REJECTED, указана причина

---

### 2.3 Добавление услуг (после одобрения)

**Шаги:**

1. Вход в личный кабинет вендора
2. Переход в "Мои услуги" / "My Services"
3. Нажатие "Добавить услугу" / "Add Service"
4. Заполнение формы услуги:
   - Название (name) \*
   - Описание (description) \*
   - Категория (categoryId) \*
   - Цена (price) \*
   - Длительность в минутах (duration)
   - Фотографии (images) - будущая функция
5. Сохранение услуги
6. Услуга автоматически получает статус ACTIVE

**API Endpoints:**

- `POST /api/v1/services` - создание услуги
  - Body: `{ name, description, price, categoryId, duration?, images? }`
- `GET /api/v1/services/my` - список своих услуг

**Ожидаемый результат:**

- Услуга создана и доступна в каталоге
- Услуга видна клиентам
- Email уведомление о создании услуги (опционально)

---

### 2.4 Управление услугами

**Шаги:**

1. Просмотр списка своих услуг
2. Редактирование услуги:
   - Изменение цены
   - Обновление описания
   - Изменение категории
3. Временное скрытие услуги (изменение статуса на INACTIVE)
4. Удаление услуги (soft delete - статус DELETED)

**API Endpoints:**

- `GET /api/v1/services/my` - список своих услуг
- `PATCH /api/v1/services/:id` - обновление услуги
- `DELETE /api/v1/services/:id` - удаление услуги

**Ожидаемый результат:**

- Услуги обновлены
- Изменения отражены в каталоге

---

### 2.5 Получение и обработка заказов

**Шаги:**

1. Переход в "Мои заказы" / "My Orders"
2. Просмотр списка заказов:
   - Новые заказы (CONFIRMED)
   - Заказы в работе (IN_PROGRESS)
   - Завершенные заказы (COMPLETED)
3. Фильтрация по статусу и дате
4. Просмотр деталей заказа:
   - Информация о клиенте
   - Список услуг
   - Запланированная дата
   - Контактная информация

**API Endpoints:**

- `GET /api/v1/orders` - список заказов вендора
  - Query: `vendorId` автоматически определяется из токена
- `GET /api/v1/orders/:id` - детали заказа

**Ожидаемый результат:**

- Вендор видит все свои заказы
- Может отслеживать статусы

---

### 2.6 Обновление статуса заказа

**Шаги:**

1. Выбор заказа со статусом CONFIRMED
2. Нажатие "Начать выполнение" / "Start Processing"
3. Статус изменен на IN_PROGRESS
4. Выполнение услуги
5. После завершения: нажатие "Завершить заказ" / "Complete Order"
6. Статус изменен на COMPLETED

**API Endpoints:**

- `PATCH /api/v1/orders/:id/status` - обновление статуса
  - Body: `{ status: IN_PROGRESS | COMPLETED }`

**Email уведомления:**

- Order Status Update отправляется клиенту при каждом изменении

**Ожидаемый результат:**

- Статус заказа обновлен
- Клиент уведомлен об изменениях
- Заказ готов к оплате вендору

---

### 2.7 Получение оплаты

**Шаги:**

1. После завершения заказа (COMPLETED)
2. Платеж обрабатывается автоматически через Stripe Connect
3. Расчет выплаты вендору:
   - Общая сумма заказа
   - Минус платформа fee (5%)
   - Минус Stripe fee (2.9% + €0.25)
   - = Выплата вендору
4. Перевод средств на счет вендора (через Stripe Connect)
5. Получение уведомления о выплате

**API Endpoints:**

- (Автоматически) Webhook обработка платежей
- `GET /api/v1/payments` - список платежей вендора

**Ожидаемый результат:**

- Средства переведены на счет вендора
- Вендор получил оплату за услугу

---

## 3. ADMIN - Критический путь администратора

### 3.1 Вход в систему

**Шаги:**

1. Переход на страницу входа администратора
2. Ввод учетных данных (email и пароль)
3. Аутентификация через Keycloak
4. Проверка роли ADMIN
5. Доступ к административной панели

**API Endpoints:**

- `POST /api/v1/auth/login` - вход
- `GET /api/v1/auth/profile` - проверка роли

**Ожидаемый результат:**

- Администратор авторизован
- Доступ к админ-панели получен

---

### 3.2 Модерация вендоров

**Шаги:**

1. Переход в "Модерация вендоров" / "Vendor Moderation"
2. Просмотр списка заявок:
   - Новые заявки (PENDING)
   - Одобренные (APPROVED)
   - Отклоненные (REJECTED)
3. Просмотр деталей заявки:
   - Информация о вендоре
   - Данные бизнеса
   - Документы (если загружены)
4. Принятие решения:
   - **Одобрение:**
     - Нажатие "Одобрить" / "Approve"
     - Статус изменен на APPROVED
     - Email: Vendor Approval отправлен вендору
   - **Отклонение:**
     - Нажатие "Отклонить" / "Reject"
     - Указание причины отклонения
     - Статус изменен на REJECTED
     - Email: Vendor Rejection отправлен вендору

**API Endpoints:**

- `GET /api/v1/admin/vendors` - список вендоров
- `PATCH /api/v1/admin/vendors/:id/status` - обновление статуса
  - Body: `{ status: APPROVED | REJECTED, reason? }`

**Ожидаемый результат:**

- Заявка обработана
- Вендор уведомлен о решении
- При одобрении: вендор может добавлять услуги

---

### 3.3 Управление категориями услуг

**Шаги:**

1. Переход в "Категории" / "Categories"
2. Просмотр списка категорий
3. **Создание новой категории:**
   - Название (name) \*
   - Slug (URL-friendly название) \*
   - Описание (description)
   - Иконка (icon)
   - Порядок сортировки (sortOrder)
4. **Редактирование категории:**
   - Изменение названия, описания
   - Изменение порядка сортировки
   - Активация/деактивация (isActive)
5. **Удаление категории:**
   - Проверка наличия услуг в категории
   - Удаление только если нет услуг

**API Endpoints:**

- `GET /api/v1/categories?includeInactive=true` - все категории
- `POST /api/v1/categories` - создание категории
- `PATCH /api/v1/categories/:id` - обновление категории
- `DELETE /api/v1/categories/:id` - удаление категории

**Ожидаемый результат:**

- Категории управляются администратором
- Каталог услуг организован

---

### 3.4 Модерация услуг

**Шаги:**

1. Переход в "Модерация услуг" / "Service Moderation"
2. Просмотр списка услуг:
   - Все услуги или по статусу
   - Фильтрация по вендору, категории
3. Просмотр деталей услуги
4. **Действия:**
   - Одобрение публикации
   - Отклонение с указанием причины
   - Редактирование (если необходимо)
   - Скрытие услуги

**API Endpoints:**

- `GET /api/v1/admin/services` - список всех услуг
- `PATCH /api/v1/admin/services/:id/status` - изменение статуса

**Ожидаемый результат:**

- Услуги проверены и одобрены
- Качество каталога поддерживается

---

### 3.5 Управление заказами

**Шаги:**

1. Переход в "Управление заказами" / "Order Management"
2. Просмотр всех заказов:
   - Фильтрация по статусу, клиенту, вендору, дате
   - Поиск по номеру заказа
3. Просмотр деталей заказа
4. **Действия:**
   - Изменение статуса заказа
   - Отмена заказа
   - Инициация возврата средств (refund)
   - Просмотр истории изменений

**API Endpoints:**

- `GET /api/v1/admin/orders` - все заказы
- `PATCH /api/v1/admin/orders/:id/status` - изменение статуса
- `POST /api/v1/admin/payments/:id/refund` - возврат средств

**Ожидаемый результат:**

- Заказы управляются администратором
- Проблемы решаются оперативно

---

### 3.6 Управление пользователями

**Шаги:**

1. Переход в "Пользователи" / "Users"
2. Просмотр списка пользователей:
   - Фильтрация по роли, статусу
   - Поиск по email, имени
3. Просмотр профиля пользователя
4. **Действия:**
   - Изменение роли пользователя
   - Блокировка/разблокировка пользователя
   - Редактирование профиля
   - Просмотр истории активности

**API Endpoints:**

- `GET /api/v1/admin/users` - список пользователей
- `PATCH /api/v1/admin/users/:id` - обновление пользователя
  - Body: `{ role?, isBlocked? }`

**Ожидаемый результат:**

- Пользователи управляются
- Безопасность платформы поддерживается

---

### 3.7 Просмотр статистики и аналитики

**Шаги:**

1. Переход в "Статистика" / "Statistics"
2. Просмотр ключевых метрик:
   - Общее количество пользователей (клиентов, вендоров)
   - Количество заказов (по статусам)
   - Объем продаж (общий, по периодам)
   - Популярные категории услуг
   - Топ вендоры
   - Средний чек
3. Экспорт отчетов (будущая функция)
4. Фильтрация по периодам

**API Endpoints:**

- `GET /api/v1/admin/stats` - общая статистика
- `GET /api/v1/admin/stats/sales` - статистика продаж
- `GET /api/v1/admin/stats/users` - статистика пользователей

**Ожидаемый результат:**

- Администратор видит состояние платформы
- Принимает решения на основе данных

---

## 4. Кросс-ролевые взаимодействия

### 4.1 Клиент ↔ Вендор

**Сценарий:** Заказ услуги

1. Клиент находит услугу вендора
2. Клиент создает заказ с услугой вендора
3. Клиент оплачивает заказ
4. Вендор получает уведомление о новом заказе
5. Вендор начинает выполнение
6. Вендор завершает заказ
7. Клиент получает услугу
8. Вендор получает оплату

**Email уведомления:**

- Клиент: Order Confirmation, Order Status Updates
- Вендор: Order Status Updates

---

### 4.2 Вендор ↔ Администратор

**Сценарий:** Модерация вендора

1. Вендор подает заявку
2. Администратор проверяет заявку
3. Администратор одобряет/отклоняет
4. Вендор получает уведомление

**Email уведомления:**

- Вендор: Vendor Approval / Vendor Rejection

---

### 4.3 Клиент ↔ Администратор

**Сценарий:** Решение проблем

1. Клиент обращается с проблемой
2. Администратор просматривает заказ клиента
3. Администратор принимает меры (отмена, возврат)
4. Клиент получает решение

---

## 5. Критические точки и обработка ошибок

### 5.1 Ошибки при регистрации

- **Email уже существует:** Показать сообщение, предложить вход
- **Слабый пароль:** Показать требования к паролю
- **Ошибка Keycloak:** Логировать, показать общую ошибку

### 5.2 Ошибки при оплате

- **Недостаточно средств:** Показать сообщение, предложить другой способ оплаты
- **Ошибка Stripe:** Логировать, откатить заказ, уведомить клиента
- **Таймаут оплаты:** Отменить payment intent, вернуть заказ в PENDING

### 5.3 Ошибки при создании заказа

- **Услуга недоступна:** Проверить статус услуги, показать сообщение
- **Вендор не одобрен:** Не показывать услуги неодобренных вендоров
- **Недостаточно данных:** Валидация на фронтенде и бэкенде

### 5.4 Ошибки при модерации

- **Некорректные данные вендора:** Запросить дополнительные документы
- **Дублирование услуг:** Проверить перед созданием, показать предупреждение

---

## 6. Email уведомления - полный список

### Для CLIENT:

1. **Welcome Email** - после регистрации
2. **Order Confirmation** - после успешной оплаты
3. **Order Status Update** - при каждом изменении статуса заказа
4. **Payment Failed** - при неудачной оплате
5. **Refund Notification** - при возврате средств

### Для VENDOR:

1. **Vendor Approval Email** - при одобрении заявки
2. **Vendor Rejection Email** - при отклонении заявки
3. **Order Status Update** - при создании/изменении заказа с его услугами
4. **Service Status Update** - при изменении статуса услуги (модерация)

### Для ADMIN:

- Email уведомления администраторам (будущая функция)

---

## 7. Метрики успешности критических путей

### Для CLIENT:

- ✅ Успешная регистрация
- ✅ Создание первого заказа
- ✅ Успешная оплата
- ✅ Получение услуги

### Для VENDOR:

- ✅ Успешная подача заявки
- ✅ Одобрение администратором
- ✅ Создание первой услуги
- ✅ Получение первого заказа
- ✅ Получение первой выплаты

### Для ADMIN:

- ✅ Обработка заявок вендоров (время < 24 часов)
- ✅ Модерация услуг (время < 48 часов)
- ✅ Решение проблем клиентов (время < 12 часов)

---

## 8. Будущие улучшения

1. **Система отзывов и рейтингов**
   - Клиенты могут оставлять отзывы после завершения заказа
   - Вендоры получают рейтинг на основе отзывов

2. **Чат между клиентом и вендором**
   - Прямое общение по заказу
   - Уведомления о новых сообщениях

3. **Продвинутая аналитика**
   - Дашборды для вендоров
   - Рекомендации услуг для клиентов

4. **Мобильное приложение**
   - Push-уведомления
   - Удобный интерфейс на мобильных устройствах

5. **Интеграция с календарем**
   - Бронирование времени для услуг
   - Напоминания о предстоящих встречах

---

**Последнее обновление:** 4 декабря 2025
**Автор:** Development Team
**Статус:** Актуально
